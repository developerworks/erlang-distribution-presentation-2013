<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=1024, user-scalable=no">

	<title>Quick Tour of Erlang Distribution Protocol</title>
	
	<!-- Required stylesheet -->
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/core/deck.core.css">
	
	<!-- Extension CSS files go here. Remove or add as needed. -->
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/extensions/goto/deck.goto.css">
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/extensions/menu/deck.menu.css">
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/extensions/navigation/deck.navigation.css">
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/extensions/status/deck.status.css">
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/extensions/hash/deck.hash.css">
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/extensions/scale/deck.scale.css">

	<!-- Style theme. More available in /themes/style/ or create your own. -->
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/themes/style/web-2.0.css">
	
	<!-- Transition theme. More available in /themes/transition/ or create your own. -->
	<link rel="stylesheet" href="imakewebthings-deck.js-e42bd0c/themes/transition/horizontal-slide.css">
	
	<!-- Required Modernizr file -->
	<script src="imakewebthings-deck.js-e42bd0c/modernizr.custom.js"></script>
</head>
<body class="deck-container">

<!-- Begin slides. Just make elements with a class of slide. -->

<section class="slide">
  <h1>Quick Tour of Erlang Distribution Protocol</h1>
</section>

<section class="slide">
  <h2>Show me the Code: Server</h2>
  <pre>
-module(server).
-behaviour(gen_server).
...
start() ->
    gen_server:start_link({local, server_quux}, ?MODULE, [], []).
...
handle_call("hello", _From, State) ->
    {reply, "world", State}.
...
  </pre>
</section>

<section class="slide">
  <h2>Show me the Code: Server (full)</h2>
  <p>for those looking for hidden AbstractSingletonFactoryImplementation</p>
  <pre>
-module(server).

-behaviour(gen_server).

-export([start/0]).

-export([init/1, handle_call/3, handle_cast/2, handle_info/2,
         terminate/2, code_change/3]).

-record(state, {}).

start() ->
    gen_server:start_link({local, server_quux}, ?MODULE, [], []).

init([]) ->
    {ok, #state{}}.

handle_call("hello", _From, State) ->
    {reply, "world", State}.

handle_cast(_Msg, State) ->
    {noreply, State}.

handle_info(_Info, State) ->
    {noreply, State}.

terminate(_Reason, _State) ->
    ok.

code_change(_OldVsn, State, _Extra) ->
    {ok, State}.
  </pre>
</section>

<section class="slide">
  <h2>Show me the Code: Client</h2>
  <pre>
-module(client).

-export([start/0]).

start() ->
    Reply = gen_server:call(
              {server_quux, 'server_node@127.0.0.1'},
              "hello"),
    io:format("reply is ~p~n", [Reply]),
    timer:sleep(30000),
    erlang:halt().
  </pre>
  <p>Yes, it's that short.</p>
</section>

<section class="slide">
  <h2>Show me the Code: Command Line</h2>
  <pre>
erlc -o ebin/ src/*.erl

erl -noshell -pa ebin -name server_node@127.0.0.1 -s server

erl -noshell -pa ebin -name client_node@127.0.0.1 -s client

  </pre>
</section>

<section class="slide">
  <h2>Tools</h2>
  <ul>
    <li>turn on distribution debugging at compile time by<br/>
      <code>cd otp/; CFLAGS="-D ERTS_DIST_MSG_DBG" make</code></li>
    <li>tcpdump or wireshark (has decoder for the protocol)</li>
  </ul>
</section>

<section class="slide">
  <h2>Watching the output</h2>
  <ul>
  <img src="img/tcpdump.gif"/>
</section>

<section class="slide">
  <h2>EPMD names</h2>
  <p>epmd - portmapper in erlang world, uses simple protocol over TCP.</p>
  <p>Both client and server tell epmd about their names, ports, protocol versions.</p>
  <p>Client asks server's port by name.</p>
  <p>epmd gives it to the client (with protocol version).</p>
</section>

<section class="slide">
  <h2>Connection handshake</h2>
  <h3>Client <span style="float: right">Server</span></h3>
  <p style="clear: both">tcp connect &rarr; <span style="float: right">&larr; tcp accept</span></p>
  <p style="clear: both">send name &rarr;</p>
  <p style="clear: both">&nbsp; <span style="float: right">&larr; send status</span></p>
  <p style="clear: both">&nbsp; <span style="float: right">&larr; send challenge</span></p>
  <p style="clear: both">send challenge reply &rarr;</p>
  <p style="clear: both">&nbsp; <span style="float: right">&larr; send challenge ack</span></p>
</section>

<section class="slide">
  <h2>RPC</h2>
  <h3>Client <span style="float: right">Server</span></h3>
  <p style="clear: both">monitor server process<br/>
    CTL: {19,&lt;0.2.0&gt;,server_quux,#Ref&lt;0.0.0.40&gt;} &rarr;</p>
  <p style="clear: both">send message to process by registered name<br/>
    CTL: {6,&lt;0.2.0&gt;,'',server_quux}<br/>
    MSG: {'$gen_call',{&lt;0.2.0&gt;,#Ref&lt;0.0.0.40&gt;},"hello"} &rarr;</p>
  <p style="clear: both">&nbsp; <span style="float: right; text-align: right">send message to pid<br>
      CTL: {2,'',&lt;0.2.0&gt;}<br/>
      &larr; MSG: {#Ref&lt;0.0.0.40&gt;,"world"}</span></p>
  <p style="clear: both">demonitor server process<br/>
    CTL: {20,&lt;0.2.0&gt;,server_quux,#Ref&lt;0.0.0.40&gt;} &rarr;</p>
</section>

<section class="slide">
  <h2>Automated housekeeping</h2>
  <ul>
    <li>ticks</li>
    <li>global</li>
  </ul>
</section>

<section class="slide">
  <h2>Don't drink too much Kool-Aid</h2>
  <ul>
    <li>fully connected mesh (N^2 connections)</li>
    <li>nodes won't reconnect automatically</li>
    <li>global names won't resync</li>
    <li>large messages are harmful</li>
    <li>no security</li>
    <li>single tcp connection between 2 nodes</li>
    <li>don't even try to use over WAN (I did)</li>
    <li>epmd could forget node or not delete dead node (rare but painful)</li>
  </ul>
</section>

<section class="slide">
  <h2>Links</h2>
  <ul>
    <li><a href="http://learnyousomeerlang.com/distribunomicon">LYSE:Distribunomicon</a></li>
    <li><a href="http://www.erlang.org/doc/apps/erts/erl_dist_protocol.html">Distribution Protocol Documentation</a></li>
    <li>Image credits: <a href="http://devopsreactions.tumblr.com/">devopsreactions.tumblr.com</a></li>
  </ul>
</section>

<section class="slide">
    <h2>Q&amp;A</h2>
    <p>Anton Lebedevich</p>
    <p>mabrek@gmail.com</p>
    <p><a target="_blank" href="https://github.com/mabrek">github.com/mabrek</a></p>
    <p><a href="http://mabrek.github.com/erlang-distribution-presentation-2013/">mabrek.github.com/erlang-distribution-presentation-2013</a></p>
    <p><a href="http://github.com/erlang-distribution-presentation-2013/">Code, logs, traces</a></p>
</section>

<!-- End slides. -->


<!-- Begin extension snippets. Add or remove as needed. -->

<!-- deck.navigation snippet -->
<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<!-- deck.status snippet -->
<p class="deck-status">
	<span class="deck-status-current"></span>
	/
	<span class="deck-status-total"></span>
</p>

<!-- deck.goto snippet -->
<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
	<datalist id="goto-datalist"></datalist>
	<input type="submit" value="Go">
</form>

<!-- deck.hash snippet -->
<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<!-- End extension snippets. -->


<!-- Required JS files. -->
<script src="imakewebthings-deck.js-e42bd0c/jquery-1.7.2.min.js"></script>
<script src="imakewebthings-deck.js-e42bd0c/core/deck.core.js"></script>

<!-- Extension JS files. Add or remove as needed. -->
<script src="imakewebthings-deck.js-e42bd0c/core/deck.core.js"></script>
<script src="imakewebthings-deck.js-e42bd0c/extensions/hash/deck.hash.js"></script>
<script src="imakewebthings-deck.js-e42bd0c/extensions/menu/deck.menu.js"></script>
<script src="imakewebthings-deck.js-e42bd0c/extensions/goto/deck.goto.js"></script>
<script src="imakewebthings-deck.js-e42bd0c/extensions/status/deck.status.js"></script>
<script src="imakewebthings-deck.js-e42bd0c/extensions/navigation/deck.navigation.js"></script>
<script src="imakewebthings-deck.js-e42bd0c/extensions/scale/deck.scale.js"></script>

<!-- Initialize the deck. You can put this in an external file if desired. -->
<script>
	$(function() {
		$.deck('.slide');
	});
</script>
</body>
</html>
